<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Режим разработчика - Управление кругами</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f0f0f0; }
        #container { display: flex; flex-direction: column; align-items: center; }
        #filters { margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
        select { padding: 5px; }
        #controls { margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
        button { padding: 10px; }
        #canvas { border: 1px solid #000; cursor: crosshair; }
        #status { margin-top: 10px; font-size: 14px; color: #555; }
    </style>
</head>
<body>
    <div id="container">
        <h1>Режим разработчика</h1>
        <div id="filters">
            <select id="groupSelect"><option>Выберите Сорт</option></select>
            <select id="subgroupSelect"><option>Выберите Круг</option></select>
        </div>
        <div id="controls">
            <button id="addCircleBtn">Добавить круг</button>
            <button id="removeCircleBtn">Удалить круг</button>
            <button id="saveChangesBtn">Сохранить изменения</button>
            <button id="exportBtn">Экспорт JSON</button>
            <input type="file" id="importInput" accept=".json" style="display: none;">
            <button id="importBtn">Импорт JSON</button>
            <button id="switchToUserBtn">Перейти в пользовательский режим</button>
        </div>
        <canvas id="canvas" width="800" height="600"></canvas>
        <div id="status">Наведите курсор на круг и нажмите Delete для удаления. Перетаскивайте для перемещения.</div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const background = new Image();
        background.src = 'https://github.com/oluneva/my_site/raw/main/my-image.jpg'; // Обновлено: новое имя файла

        let circles = JSON.parse(localStorage.getItem('circles')) || []; // Загружаем из localStorage
        let data = []; // Данные из CSV
        let filteredData = [];
        let selectedFilters = { group: '', subgroup: '' };
        let draggedCircle = null;
        let newCircles = new Set(); // Для отслеживания новых кругов (красные)

        // Функция загрузки CSV (асинхронно)
        async function loadCSV() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/oluneva/my_site/main/Plants.csv');
                if (!response.ok) throw new Error('Файл не найден');
                const buffer = await response.arrayBuffer();
                const decoder = new TextDecoder('windows-1251');
                const csvText = decoder.decode(buffer);
                data = parseCSV(csvText);
                if (data.length === 0) throw new Error('CSV пустой или некорректный');
                filteredData = data;
                console.log('CSV загружен успешно:', data.length, 'строк');
                updateFilters();
            } catch (e) {
                console.warn('CSV не загружен, используем демо-данные:', e.message);
                data = [
                    { Сорт: 'Сорт1', Подгруппа: 'Подгруппа1' },
                    { Сорт: 'Сорт2', Подгруппа: 'Подгруппа2' }
                ];
                filteredData = data;
                updateFilters();
            }
        }

        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            if (lines.length < 1) return [];
            const headers = lines[0].split(',').map(h => h.trim());
            const expectedHeaders = ['Класс', 'Подкласс', 'Тип', 'Подтип', 'Сорт', 'Подгруппа'];
            if (!expectedHeaders.every(h => headers.includes(h))) {
                console.warn('Заголовки CSV не совпадают, используем демо-данные');
                return [];
            }
            return lines.slice(1).map(line => {
                const values = line.split(',');
                let obj = {};
                headers.forEach((h, i) => obj[h] = values[i]?.trim() || '');
                return obj;
            }).filter(obj => obj['Класс']); // Фильтр пустых строк
        }

        function updateFilters() {
            const selects = ['groupSelect', 'subgroupSelect'];
            const keys = ['Сорт', 'Подгруппа'];
            selects.forEach((id, i) => {
                const select = document.getElementById(id);
                select.innerHTML = `<option>Выберите ${i === 0 ? 'Сорт' : 'Круг'}</option>`;
                if (i === 0) {
                    const unique = [...new Set(filteredData.map(d => d[keys[i]]))].filter(v => v);
                    unique.forEach(val => {
                        const option = document.createElement('option');
                        option.value = val;
                        option.textContent = val;
                        select.appendChild(option);
                    });
                } else {
                    // Для последнего фильтра: показать ID кругов, соответствующих выбранным фильтрам, без пустых и дубликатов
                    const matchingCircles = circles.filter(c => c.id && c.id.trim() !== '').filter(circle => {
                        const circleType = circle.type || 'Сорт1';
                        return (!selectedFilters.group || circleType.includes(selectedFilters.group)) &&
                               (!selectedFilters.subgroup || circleType.includes(selectedFilters.subgroup));
                    });
                    const uniqueIds = [...new Set(matchingCircles.map(c => c.id))];
                    uniqueIds.forEach(id => {
                        const option = document.createElement('option');
                        option.value = id;
                        option.textContent = id;
                        select.appendChild(option);
                    });
                }
            });
        }

        function cascadeFilters(changedKey) {
            const keys = ['Сорт', 'Подгруппа'];
            const index = keys.indexOf(changedKey);
            filteredData = data.filter(d => {
                return keys.slice(0, index + 1).every(key => !selectedFilters[key.toLowerCase()] || d[key] === selectedFilters[key.toLowerCase()]);
            });
            updateFilters();
        }

        // Обработчики фильтров
        document.getElementById('groupSelect').addEventListener('change', e => { selectedFilters.group = e.target.value; cascadeFilters('Сорт'); });
        document.getElementById('subgroupSelect').addEventListener('change', e => { selectedFilters.subgroup = e.target.value; cascadeFilters('Подгруппа'); });

        function renderCircles() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(background, 0, 0, canvas.width, canvas.height);
            circles.forEach(circle => {
                if (!circle || !circle.id) return;
                ctx.beginPath();
                ctx.arc(circle.x, circle.y, 15, 0, 2 * Math.PI); // Уменьшен радиус до 15
                ctx.fillStyle = newCircles.has(circle.id) ? 'red' : 'orange'; // Новые красные, старые оранжевые
                ctx.fill();
                ctx.stroke();
                // Убрана подпись: ctx.fillText(circle.id, circle.x - 15, circle.y + 5);
            });
        }

        function saveCircles() {
            localStorage.setItem('circles', JSON.stringify(circles));
        }

        function generateId() {
            // Найти все существующие ID, извлечь номера, найти max
            const existingIds = circles.map(c => c.id).filter(id => id && id.startsWith('circle_'));
            let maxNum = 0;
            existingIds.forEach(id => {
                const num = parseInt(id.replace('circle_', ''));
                if (!isNaN(num) && num > maxNum) maxNum = num;
            });
            return 'circle_' + (maxNum + 1);
        }

        // Вспомогательная функция для добавления круга в позицию
        function addCircleAtPosition(x, y) {
            const id = generateId();
            circles.push({ id, x, y });
            newCircles.add(id); // Новый круг - красный
            saveCircles();
            renderCircles();
            updateFilters(); // Обновить фильтры после добавления
        }

        // Обработчик для кнопки "Добавить круг" - добавляет круг в центре canvas
        document.getElementById('addCircleBtn').addEventListener('click', () => {
            const x = canvas.width / 2;
            const y = canvas.height / 2;
            addCircleAtPosition(x, y);
        });

        // Загрузка фона и начальный рендер
        background.onload = () => {
            renderCircles();
        };

        // Загрузка CSV при старте
        loadCSV();
    </script>
</body>
</html>
