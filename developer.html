<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Режим разработчика - Управление кругами</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f0f0f0; }
        #container { display: flex; flex-direction: column; align-items: center; }
        #content { width: 100%; max-width: 1200px; display: flex; justify-content: space-between; align-items: flex-start; gap: 20px; }
        #leftPanel { /* Пусто, чтобы канвас был слева */ }
        #rightPanel { display: flex; flex-direction: column; gap: 10px; }
        #canvasContainer { flex: 1; display: flex; justify-content: center; }
        select { padding: 5px; }
        button { padding: 10px; }
        #canvas { border: 1px solid #000; cursor: crosshair; }
        #status { margin-top: 10px; font-size: 14px; color: #555; text-align: center; }
    </style>
</head>
<body>
    <div id="container">
        <div id="content">
            <div id="leftPanel"></div>
            <div id="canvasContainer">
                <canvas id="canvas" width="800" height="600"></canvas>
            </div>
            <div id="rightPanel">
                <div id="controls">
                    <button id="addCircleBtn">Добавить круг</button>
                    <button id="removeCircleBtn">Удалить круг</button>
                    <button id="saveChangesBtn">Сохранить изменения</button>
                    <button id="exportBtn">Экспорт JSON</button>
                    <input type="file" id="importInput" accept=".json" style="display: none;">
                    <button id="importBtn">Импорт JSON</button>
                    <button id="switchToUserBtn">Перейти в пользовательский режим</button>
                </div>
                <div id="filters">
                    <select id="groupSelect">
                        <option>Выберите Сорт</option>
                    </select>
                    <select id="subgroupSelect">
                        <option>Выберите Круг</option>
                    </select>
                </div>
                <div id="status">Наведите курсор на круг и нажмите Delete для удаления. Перетаскивайте для перемещения.</div>
            </div>
        </div>
    </div>

    <script>
        // Временно закомментирован prompt для тестирования (заменено на фиксированный пароль)
        // const password = prompt('Введите пароль:');
        const password = 'developer'; // Временно без prompt для проверки

        if (password !== 'developer') {
            // Если пароль неправильный, оставляем пустую страницу (ничего не загружается)
            document.body.innerHTML = '';
            return;
        }

        // Если пароль правильный, инициализируем интерфейс (весь код загрузки теперь здесь)
        const ctx = document.getElementById('canvas').getContext('2d');
        const background = new Image();

        let circles = [];
        let data = [];
        let filteredData = [];
        let selectedFilters = { 'Сорт': '', 'Круг': '' };
        let draggedCircle = null;
        let newCircles = new Set();

        async function loadCircles() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/oluneva/my_site/main/circles_export.json');
                if (!response.ok) throw new Error('Файл не найден');
                const data = await response.json();
                circles = data.map(c => ({
                    ...c,
                    id: String(c.id || '')
                }));
            } catch (e) {
                circles = [];
            }
            renderCircles();
            updateFilters();
        }

        async function loadCSV() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/oluneva/my_site/main/Plants.csv');
                if (!response.ok) throw new Error('Файл не найден');
                const buffer = await response.arrayBuffer();
                const decoder = new TextDecoder('windows-1251');
                const csvText = decoder.decode(buffer);
                data = parseCSV(csvText);
                console.log('Загруженные данные из CSV:', data);
                if (data.length === 0) throw new Error('CSV пустой или некорректный');
                filteredData = data;
                updateFilters();
            } catch (e) {
                console.error('Ошибка загрузки CSV:', e);
                data = [
                    { Сорт: 'Сорт1', Круг: 'Круг1' },
                    { Сорт: 'Сорт2', Круг: 'Круг2' }
                ];
                filteredData = data;
                updateFilters();
            }
        }

        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            if (lines.length < 1) return [];
            // Разделитель ';'
            const headers = lines[0].split(';').map(h => h.trim());
            console.log('Заголовки CSV:', headers);
            return lines.slice(1).map(line => {
                const values = line.split(';').map(v => v.trim().replace(/^"|"$/g, ''));
                let obj = {};
                headers.forEach((h, i) => obj[h] = values[i] || '');
                return obj;
            });
        }

        function updateFilters() {
            const selects = ['groupSelect', 'subgroupSelect'];
            const keys = ['Сорт', 'Круг'];
            selects.forEach((id, i) => {
                const select = document.getElementById(id);
                select.innerHTML = `<option>Выберите ${keys[i]}</option>`;
                const unique = [...new Set(filteredData.map(d => d[keys[i]]))].filter(v => v);
                console.log(`Уникальные для ${keys[i]}:`, unique);
                unique.forEach(val => {
                    const option = document.createElement('option');
                    option.value = val;
                    option.textContent = val;
                    select.appendChild(option);
                });
            });
        }

        function cascadeFilters(changedKey) {
            const keys = ['Сорт', 'Круг'];
            const selects = ['groupSelect', 'subgroupSelect'];
            const index = keys.indexOf(changedKey);
            if (index === 0) {
                selectedFilters['Круг'] = '';
                filteredData = selectedFilters['Сорт'] ? data.filter(d => d['Сорт'] === selectedFilters['Сорт']) : data;
                updateFilters();
                document.getElementById('subgroupSelect').value = '';
            } else if (index === 1) {
                renderCircles();
            }
        }

        function renderCircles() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(background, 0, 0, canvas.width, canvas.height);
            circles.forEach(circle => {
                const isFiltered = selectedFilters['Круг'] && circle.id !== selectedFilters['Круг'];
                if (!isFiltered) {
                    ctx.beginPath();
                    ctx.arc(circle.x, circle.y, 15, 0, Math.PI * 2);
                    ctx.fillStyle = newCircles.has(circle) ? 'rgba(255, 0, 0, 0.7)' : 'rgba(0, 0, 255, 0.7)';
                    ctx.fill();
                    ctx.strokeStyle = '#000';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
            });
        }

        function getMousePos(evt) {
            const rect = canvas.getBoundingClientRect();
            return { x: evt.clientX - rect.left, y: evt.clientY - rect.top };
        }

        const canvas = document.getElementById('canvas');
        canvas.addEventListener('mousedown', (e) => {
            const pos = getMousePos(e);
            draggedCircle = circles.find(c => Math.sqrt((c.x - pos.x) ** 2 + (c.y - pos.y) ** 2) < 15);
        });

        canvas.addEventListener('mousemove', (e) => {
            if (draggedCircle) {
                const pos = getMousePos(e);
                draggedCircle.x = pos.x;
                draggedCircle.y = pos.y;
                renderCircles();
            }
        });

        canvas.addEventListener('mouseup', () => draggedCircle = null);

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Delete' && draggedCircle) {
                circles = circles.filter(c => c !== draggedCircle);
                draggedCircle = null;
                renderCircles();
            }
        });

        document.getElementById('addCircleBtn').addEventListener('click', () => {
            const newCircle = { x: Math.random() * (canvas.width - 30) + 15, y: Math.random() * (canvas.height - 30) + 15, id: '' };
            circles.push(newCircle);
            newCircles.add(newCircle);
            renderCircles();
        });

        document.getElementById('removeCircleBtn').addEventListener('click', () => {
            if (circles.length > 0) {
                circles.pop();
                renderCircles();
            }
        });

        document.getElementById('saveChangesBtn').addEventListener('click', () => {
            console.log('Сохранение изменений...');
        });

        document.getElementById('exportBtn').addEventListener('click', () => {
            const dataStr = JSON.stringify(circles, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'circles_export.json';
            a.click();
            URL.revokeObjectURL(url);
        });

        document.getElementById('importBtn').addEventListener('click', () => {
            document.getElementById('importInput').click();
        });

        document.getElementById('importInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        circles = JSON.parse(evt.target.result);
                        renderCircles();
                    } catch (err) {
                        alert('Ошибка парсинга JSON');
                    }
                };
                reader.readAsText(file);
            }
        });

        document.getElementById('switchToUserBtn').addEventListener('click', () => {
            window.location.href = 'index.html';
        });

        document.getElementById('groupSelect').addEventListener('change', (e) => {
            selectedFilters['Сорт'] = e.target.value;
            cascadeFilters('Сорт');
        });

        document.getElementById('subgroupSelect').addEventListener('change', (e) => {
            selectedFilters['Круг'] = e.target.value;
            cascadeFilters('Круг');
        });

        // Загружаем фон и данные ТОЛЬКО после проверки пароля
        background.src = 'https://github.com/oluneva/my_site/raw/main/my-image.jpg';
        background.onload = () => {
            loadCircles();
            loadCSV();
        };
    </script>
</body>
</html>
