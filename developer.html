<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Режим разработчика</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #imageContainer { position: relative; display: inline-block; border: 1px solid #ccc; }
        #image { max-width: 100%; height: auto; }
        .circle { position: absolute; width: 20px; height: 20px; border-radius: 50%; background-color: rgba(255, 0, 0, 0.5); cursor: move; }
        .circle.selected { border: 2px solid blue; }
        #controls { margin-top: 20px; }
        select { margin-right: 10px; }
        <!-- НОВОЕ: Стили для кнопки экспорта -->
        #exportButton { background-color: #4CAF50; color: white; border: none; padding: 10px 20px; cursor: pointer; margin-left: 10px; }
        #exportButton:hover { background-color: #45a049; }
    </style>
</head>
<body>
    <h1>Режим разработчика</h1>
    <div id="imageContainer">
        <img id="image" src="my-image.jpg" alt="Изображение" onload="init()">
    </div>
    <div id="controls">
        <!-- Фильтры (как в предыдущем коде) -->
        <label>Класс: <select id="classSelect"></select></label>
        <label>Подкласс: <select id="subclassSelect"></select></label>
        <label>Семейство: <select id="familySelect"></select></label>
        <label>Род: <select id="genusSelect"></select></label>
        <label>Вид: <select id="speciesSelect"></select></label>
        <label>Сорт: <select id="varietySelect"></select></label>
        <!-- НОВОЕ: Кнопка экспорта -->
        <button id="exportButton">Экспорт координат кругов</button>
    </div>

    <script>
        // Глобальные переменные (как в предыдущем коде)
        let circles = JSON.parse(localStorage.getItem('circles')) || [];
        let data = [];
        let selectedCircle = null;
        let offsetX, offsetY;
        let imageWidth, imageHeight;

        // Загрузка CSV (как в предыдущем коде)
        fetch('data.csv')
            .then(response => response.arrayBuffer())
            .then(buffer => {
                const decoder = new TextDecoder('windows-1251');
                const csvText = decoder.decode(buffer);
                Papa.parse(csvText, {
                    header: true,
                    complete: function(results) {
                        data = results.data;
                        initFilters();
                    }
                });
            });

        // Инициализация (как в предыдущем коде, с исправлениями)
        function init() {
            const image = document.getElementById('image');
            imageWidth = image.naturalWidth;
            imageHeight = image.naturalHeight;
            renderCircles();
            initFilters();
        }

        // Рендеринг кругов (как в предыдущем коде)
        function renderCircles() {
            const container = document.getElementById('imageContainer');
            container.querySelectorAll('.circle').forEach(c => c.remove());
            circles.forEach(circle => {
                const div = document.createElement('div');
                div.className = 'circle';
                div.id = circle.id;
                div.style.left = (circle.x / 100 * imageWidth) + 'px';
                div.style.top = (circle.y / 100 * imageHeight) + 'px';
                div.addEventListener('mousedown', startDrag);
                container.appendChild(div);
            });
            localStorage.setItem('circles', JSON.stringify(circles));
        }

        // Добавление нового круга (как в предыдущем коде)
        document.getElementById('imageContainer').addEventListener('click', function(e) {
            if (e.target.id !== 'image') return;
            const rect = e.target.getBoundingClientRect();
            const x = ((e.clientX - rect.left) / rect.width) * 100;
            const y = ((e.clientY - rect.top) / rect.height) * 100;
            const id = prompt('Введите имя круга:');
            if (id) {
                circles.push({ id, x, y });
                renderCircles();
            }
        });

        // Drag-and-drop (как в предыдущем коде)
        function startDrag(e) {
            selectedCircle = e.target;
            const rect = selectedCircle.getBoundingClientRect();
            offsetX = e.clientX - rect.left;
            offsetY = e.clientY - rect.top;
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDrag);
        }

        function drag(e) {
            if (!selectedCircle) return;
            const container = document.getElementById('imageContainer');
            const rect = container.getBoundingClientRect();
            const x = ((e.clientX - rect.left - offsetX + 10) / rect.width) * 100; // +10 для центрирования
            const y = ((e.clientY - rect.top - offsetY + 10) / rect.height) * 100;
            selectedCircle.style.left = (x / 100 * imageWidth) + 'px';
            selectedCircle.style.top = (y / 100 * imageHeight) + 'px';
            const circleIndex = circles.findIndex(c => c.id === selectedCircle.id);
            circles[circleIndex].x = x;
            circles[circleIndex].y = y;
        }

        function stopDrag() {
            selectedCircle = null;
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('mouseup', stopDrag);
            renderCircles();
        }

        // Фильтры (как в предыдущем коде)
        function initFilters() {
            const classSelect = document.getElementById('classSelect');
            const uniqueClasses = [...new Set(data.map(d => d['Класс']))].filter(Boolean);
            uniqueClasses.forEach(cls => {
                const option = document.createElement('option');
                option.value = cls;
                option.textContent = cls;
                classSelect.appendChild(option);
            });

            classSelect.addEventListener('change', updateFilters);
            // Аналогично для других фильтров...
        }

        function updateFilters() {
            // Логика каскадных фильтров (как в предыдущем коде)
        }

        // НОВОЕ: Обработчик экспорта
        document.getElementById('exportButton').addEventListener('click', function() {
            if (circles.length === 0) {
                alert('Нет кругов для экспорта!');
                return;
            }
            const dataStr = JSON.stringify(circles, null, 2); // Форматированный JSON
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = 'circles_export.json';
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        });
    </script>
</body>
</html>

