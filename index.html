<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Пользовательский режим - Просмотр кругов</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f0f0f0; }
        #container { display: flex; flex-direction: column; align-items: center; }
        #filters { margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
        select { padding: 5px; }
        #controls { margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
        button { padding: 10px; }
        #canvas { border: 1px solid #000; }
        #status { margin-top: 10px; font-size: 14px; color: #555; }
    </style>
</head>
<body>
    <div id="container">
        <h1>Пользовательский режим</h1>
        <div id="filters">
            <select id="classSelect"><option>Выберите Класс</option></select>
            <select id="subclassSelect"><option>Выберите Семейство</option></select>
            <select id="typeSelect"><option>Выберите Род</option></select>
            <select id="subtypeSelect"><option>Выберите Вид</option></select>
            <select id="groupSelect"><option>Выберите Сорт</option></select>
            <select id="subgroupSelect"><option>Выберите Круг</option></select>
        </div>
        <div id="controls">
            <button id="findPlantBtn">Найти растение</button>
            <button id="switchToDeveloperBtn">Перейти в режим разработчика</button>
        </div>
        <canvas id="canvas" width="800" height="600"></canvas>
        <div id="status">Загрузка данных...</div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const background = new Image();
        background.src = 'https://github.com/oluneva/my_site/raw/main/my-image.jpg';

        let circles = [];
        let data = [];
        let selectedFilters = { class: '', subclass: '', type: '', subtype: '', group: '', subgroup: '' };
        let blinkingCircleId = null;
        let blinkInterval = null;
        let isBlinking = false;
        let csvLoaded = false;

        // Функция загрузки кругов из circles_export.json
        async function loadCircles() {
            try {
                console.log('Пытаюсь загрузить circles_export.json...');
                const response = await fetch('https://raw.githubusercontent.com/oluneva/my_site/main/circles_export.json');
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                circles = await response.json();
                circles = circles.filter(circle => circle && typeof circle.id === 'string' && circle.id.trim() !== '' && typeof circle.x === 'number' && typeof circle.y === 'number');
                if (circles.length === 0) throw new Error('JSON пустой или некорректный');
                console.log('Круги загружены из circles_export.json:', circles.length, 'кругов');
                document.getElementById('status').textContent = `Загружено ${circles.length} кругов.`;
            } catch (e) {
                console.warn('Не удалось загрузить circles_export.json, используем дефолтные круги:', e.message);
                circles = [
                    { id: 'Круг1', x: 100, y: 100 },
                    { id: 'Круг2', x: 200, y: 200 },
                    { id: 'Круг3', x: 300, y: 300 }
                ];
                document.getElementById('status').textContent = 'Используются демо-круги.';
            }
        }

        // Загрузка и парсинг CSV с разделителем ";"
        async function loadCSV() {
            try {
                console.log('Пытаюсь загрузить Plants.csv...');
                const response = await fetch('https://raw.githubusercontent.com/oluneva/my_site/main/Plants.csv');
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                const buffer = await response.arrayBuffer();
                const decoder = new TextDecoder('windows-1251');  // Измените на 'utf-8', если символы искажены
                const csvText = decoder.decode(buffer);
                console.log('Сырой текст CSV (первые 500 символов):', csvText.substring(0, 500));

                // Парсинг с разделителем ";"
                const rows = csvText.split('\n').filter(row => row.trim() !== '');
                if (rows.length < 2) throw new Error('CSV содержит менее 2 строк (заголовки + данные)');
                const headers = rows[0].split(';').map(h => h.replace(/^"|"$/g, '').trim());
                console.log('Заголовки:', headers);
                if (headers.length !== 6 || !headers.includes('Класс') || !headers.includes('Круг')) {
                    throw new Error('Заголовки CSV не соответствуют ожидаемым: ["Класс", "Семейство", "Род", "Вид", "Сорт", "Круг"]');
                }

                data = rows.slice(1).map(row => {
                    const cells = row.split(';').map(cell => cell.replace(/^"|"$/g, '').trim());
                    if (cells.length !== 6) return null;
                    return {
                        class: cells[0],     // Класс
                        subclass: cells[1],  // Семейство
                        type: cells[2],      // Род
                        subtype: cells[3],   // Вид
                        group: cells[4],     // Сорт
                        subgroup: cells[5]  // Круг
                    };
                }).filter(item => item && item.class && item.subgroup);
                console.log('Данные загружены из CSV:', data.length, 'записей');
                csvLoaded = true;
                document.getElementById('status').textContent += ' Данные фильтров загружены.';
            } catch (e) {
                console.warn('Ошибка загрузки/парсинга CSV, используем демо-данные для фильтров:', e.message);
                data = [
                    { class: 'Класс1', subclass: 'Семейство1', type: 'Род1', subtype: 'Вид1', group: 'Сорт1', subgroup: 'Круг1' },
                    { class: 'Класс1', subclass: 'Семейство1', type: 'Род1', subtype: 'Вид1', group: 'Сорт1', subgroup: 'Круг2' },
                    { class: 'Класс2', subclass: 'Семейство2', type: 'Род2', subtype: 'Вид2', group: 'Сорт2', subgroup: 'Круг3' }
                ];
                document.getElementById('status').textContent += ' Используются демо-данные для фильтров.';
            }
        }

        // Заполнение фильтров
        function populateFilters() {
            const classSelect = document.getElementById('classSelect');
            const subclassSelect = document.getElementById('subclassSelect');
            const typeSelect = document.getElementById('typeSelect');
            const subtypeSelect = document.getElementById('subtypeSelect');
            const groupSelect = document.getElementById('groupSelect');
            const subgroupSelect = document.getElementById('subgroupSelect');

            // Класс
            const classes = [...new Set(data.map(d => d.class))].sort();
            classSelect.innerHTML = '<option>Выберите Класс</option>' + classes.map(c => `<option value="${c}">${c}</option>`).join('');

            classSelect.addEventListener('change', () => {
                selectedFilters.class = classSelect.value;
                selectedFilters.subclass = '';
                selectedFilters.type = '';
                selectedFilters.subtype = '';
                selectedFilters.group = '';
                selectedFilters.subgroup = '';
                updateSubclass();
            });

            function updateSubclass() {
                const subclasses = [...new Set(data.filter(d => !selectedFilters.class || d.class === selectedFilters.class).map(d => d.subclass))].sort();
                subclassSelect.innerHTML = '<option>Выберите Семейство</option>' + subclasses.map(c => `<option value="${c}">${c}</option>`).join('');
                subclassSelect.disabled = subclasses.length === 0;
                updateType();
            }

            subclassSelect.addEventListener('change', () => {
                selectedFilters.subclass = subclassSelect.value;
                selectedFilters.type = '';
                selectedFilters.subtype = '';
                selectedFilters.group = '';
                selectedFilters.subgroup = '';
                updateType();
            });

            function updateType() {
                const types = [...new Set(data.filter(d => (!selectedFilters.class || d.class === selectedFilters.class) && (!selectedFilters.subclass || d.subclass === selectedFilters.subclass)).map(d => d.type))].sort();
                typeSelect.innerHTML = '<option>Выберите Род</option>' + types.map(c => `<option value="${c}">${c}</option>`).join('');
                typeSelect.disabled = types.length === 0;
                updateSubtype();
            }

            typeSelect.addEventListener('change', () => {
                selectedFilters.type = typeSelect.value;
                selectedFilters.subtype = '';
                selectedFilters.group = '';
                selectedFilters.subgroup = '';
                updateSubtype();
            });

            function updateSubtype() {
                const subtypes = [...new Set(data.filter(d => (!selectedFilters.class || d.class === selectedFilters.class) && (!selectedFilters.subclass || d.subclass === selectedFilters.subclass) && (!selectedFilters.type || d.type === selectedFilters.type)).map(d => d.subtype))].sort();
                subtypeSelect.innerHTML = '<option>Выберите Вид</option>' + subtypes.map(c => `<option value="${c}">${c}</option>`).join('');
                subtypeSelect.disabled = subtypes.length === 0;
                updateGroup();
            }

            subtypeSelect.addEventListener('change', () => {
                selectedFilters.subtype = subtypeSelect.value;
                selectedFilters.group = '';
                selectedFilters.subgroup = '';
                updateGroup();
            });

            function updateGroup() {
                const groups = [...new Set(data.filter(d => (!selectedFilters.class || d.class === selectedFilters.class) && (!selectedFilters.subclass || d.subclass === selectedFilters.subclass) && (!selectedFilters.type || d.type === selectedFilters.type) && (!selectedFilters.subtype || d.subtype === selectedFilters.subtype)).map(d => d.group))].sort();
                groupSelect.innerHTML = '<option>Выберите Сорт</option>' + groups.map(c => `<option value="${c}">${c}</option>`).join('');
                groupSelect.disabled = groups.length === 0;
                updateSubgroup();
            }

            groupSelect.addEventListener('change', () => {
                selectedFilters.group = groupSelect.value;
                selectedFilters.subgroup = '';
                updateSubgroup();
            });

            function updateSubgroup() {
                const subgroups = [...new Set(data.filter(d => (!selectedFilters.class || d.class === selectedFilters.class) && (!selectedFilters.subclass || d.subclass === selectedFilters.subclass) && (!selectedFilters.type || d.type === selectedFilters.type) && (!selectedFilters.subtype || d.subtype === selectedFilters.subtype) && (!selectedFilters.group || d.group === selectedFilters.group)).map(d => d.subgroup))].sort();
                subgroupSelect.innerHTML = '<option>Выберите Круг</option>' + subgroups.map(c => `<option value="${c}">${c}</option>`).join('');
                subgroupSelect.disabled = subgroups.length === 0;
            }

            subgroupSelect.addEventListener('change', () => {
                selectedFilters.subgroup = subgroupSelect.value;
            });
        }

        // Рендеринг кругов (всегда отображаются)
        function drawCircles() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (background.complete) {
                ctx.drawImage(background, 0, 0, canvas.width, canvas.height);
            }
            circles.forEach(circle => {
                ctx.beginPath();
                ctx.arc(circle.x, circle.y, 20, 0, 2 * Math.PI);
                if (isBlinking && blinkingCircleId === circle.id) {
                    ctx.fillStyle = 'red';
                } else {
                    ctx.fillStyle = 'rgba(0, 128, 0, 0.5)';
                }
                ctx.fill();
                ctx.strokeStyle = 'black';
                ctx.stroke();
                ctx.fillStyle = 'black';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(circle.id, circle.x, circle.y + 5);
            });
        }

        // Мигание круга
        function blinkCircle(id) {
            if (isBlinking) {
                clearInterval(blinkInterval);
                isBlinking = false;
            }
            const circle = circles.find(c => c.id === id);
            if (!circle) {
                document.getElementById('status').textContent = 'Круг с таким ID не найден.';
                return;
            }
            blinkingCircleId = id;
            isBlinking = true;
            let blinkCount = 0;
            blinkInterval = setInterval(() => {
                drawCircles();
                blinkCount++;
                if (blinkCount >= 6) {  // 3 секунды (6 раз по 500мс)
                    clearInterval(blinkInterval);
                    isBlinking = false;
                    blinkingCircleId = null;
                    drawCircles();
                }
            }, 500);
        }

        // Инициализация
        async function init() {
            await Promise.all([loadCircles(), loadCSV()]);
            populateFilters();
            drawCircles();
            background.onload = drawCircles;
        }

        init();

        // Кнопка "Найти растение"
        document.getElementById('findPlantBtn').addEventListener('click', () => {
            if (!selectedFilters.subgroup) {
                document.getElementById('status').textContent = 'Сначала выберите круг в фильтре.';
                return;
            }
            blinkCircle(selectedFilters.subgroup);
        });

        // Кнопка перехода в режим разработчика (заглушка)
        document.getElementById('switchToDeveloperBtn').addEventListener('click', () => {
            alert('Переход в режим разработчика (не реализовано)');
        });
    </script>
</body>
</html>
