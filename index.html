<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Пользовательский режим - Просмотр кругов</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f0f0f0; }
        #container { display: flex; flex-direction: column; align-items: center; }
        #filters { margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
        select { padding: 5px; }
        #controls { margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
        button { padding: 10px; }
        #canvas { border: 1px solid #000; }
        #status { margin-top: 10px; font-size: 14px; color: #555; }
    </style>
</head>
<body>
    <div id="container">
        <h1>Пользовательский режим</h1>
        <div id="filters">
            <select id="classSelect"><option>Выберите Класс</option></select>
            <select id="subclassSelect"><option>Выберите Подкласс</option></select>
            <select id="typeSelect"><option>Выберите Тип</option></select>
            <select id="subtypeSelect"><option>Выберите Подтип</option></select>
            <select id="groupSelect"><option>Выберите Группу</option></select>
            <select id="subgroupSelect"><option>Выберите Круг</option></select>
        </div>
        <div id="controls">
            <button id="findPlantBtn">Найти растение</button>
            <button id="switchToDeveloperBtn">Перейти в режим разработчика</button>
        </div>
        <canvas id="canvas" width="800" height="600"></canvas>
        <div id="status">Загрузка данных...</div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const background = new Image();
        background.src = 'https://github.com/oluneva/my_site/raw/main/my-image.jpg';

        let circles = [];
        let data = [];
        let filteredData = [];
        let selectedFilters = { class: '', subclass: '', type: '', subtype: '', group: '', subgroup: '' };
        let blinkingCircleId = null;
        let blinkInterval = null;
        let isBlinking = false;

        // Функция загрузки кругов из circles_export.json
        async function loadCircles() {
            try {
                console.log('Пытаюсь загрузить circles_export.json...');
                const response = await fetch('https://raw.githubusercontent.com/oluneva/my_site/main/circles_export.json');
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                circles = await response.json();
                circles = circles.filter(circle => circle && typeof circle.id === 'string' && circle.id.trim() !== '' && typeof circle.x === 'number' && typeof circle.y === 'number');
                if (circles.length === 0) throw new Error('JSON пустой или некорректный');
                console.log('Круги загружены из circles_export.json:', circles.length, 'кругов');
                document.getElementById('status').textContent = `Загружено ${circles.length} кругов.`;
            } catch (e) {
                console.warn('Не удалось загрузить circles_export.json, используем дефолтные круги:', e.message);
                circles = [
                    { id: 'Подгруппа1', x: 100, y: 100 },
                    { id: 'Подгруппа2', x: 200, y: 200 },
                    { id: 'Подгруппа3', x: 300, y: 300 }
                ];
                document.getElementById('status').textContent = 'Используются демо-круги.';
            }
        }

        // Загрузка и парсинг CSV с разделителем ";"
        async function loadCSV() {
            try {
                console.log('Пытаюсь загрузить Plants.csv...');
                const response = await fetch('https://raw.githubusercontent.com/oluneva/my_site/main/Plants.csv');
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                const buffer = await response.arrayBuffer();
                const decoder = new TextDecoder('windows-1251');  // Измените на 'utf-8', если символы искажены
                const csvText = decoder.decode(buffer);
                console.log('Сырой текст CSV (первые 500 символов):', csvText.substring(0, 500));

                // Парсинг с разделителем ";"
                const rows = csvText.split('\n').filter(row => row.trim() !== '');
                if (rows.length < 2) throw new Error('CSV содержит менее 2 строк (заголовки + данные)');
                const headers = rows[0].split(';').map(h => h.replace(/^"|"$/g, '').trim());
                console.log('Заголовки:', headers);
                if (headers.length !== 6 || !headers.includes('Класс') || !headers.includes('Подгруппа')) {
                    throw new Error('Заголовки CSV не соответствуют ожидаемым: ["Класс", "Подкласс", "Тип", "Подтип", "Группа", "Подгруппа"]');
                }
                data = rows.slice(1).map(row => {
                    const cells = row.split(';').map(cell => cell.replace(/^"|"$/g, '').trim());
                    if (cells.length !== 6) {
                        console.warn('Строка с неправильным количеством столбцов:', row);
                        return null;
                    }
                    return {
                        class: cells[0],
                        subclass: cells[1],
                        type: cells[2],
                        subtype: cells[3],
                        group: cells[4],
                        subgroup: cells[5]
                    };
                }).filter(item => item && item.subgroup);  // Убираем пустые строки
                if (data.length === 0) throw new Error('Парсинг дал пустой массив данных');
                console.log('Данные загружены из CSV:', data.length, 'записей');
                filteredData = [...data];
                populateFilters();
                document.getElementById('status').textContent = `Загружено ${data.length} записей из CSV.`;
            } catch (e) {
                console.error('Ошибка загрузки/парсинга CSV:', e.message);
                data = [
                    { class: 'Класс1', subclass: 'Подкласс1', type: 'Тип1', subtype: 'Подтип1', group: 'Группа1', subgroup: 'Подгруппа1' },
                    { class: 'Класс2', subclass: 'Подкласс2', type: 'Тип2', subtype: 'Подтип2', group: 'Группа2', subgroup: 'Подгруппа2' }
                ];
                filteredData = [...data];
                populateFilters();
                document.getElementById('status').textContent = 'Используются демо-данные. Проверьте консоль для деталей ошибки.';
            }
        }

        // Заполнение фильтров
        function populateFilters() {
            const classSelect = document.getElementById('classSelect');
            const subclassSelect = document.getElementById('subclassSelect');
            const typeSelect = document.getElementById('typeSelect');
            const subtypeSelect = document.getElementById('subtypeSelect');
            const groupSelect = document.getElementById('groupSelect');
            const subgroupSelect = document.getElementById('subgroupSelect');

            // Класс
            classSelect.innerHTML = '<option>Выберите Класс</option>';
            const classes = [...new Set(filteredData.map(item => item.class))].sort();
            classes.forEach(cls => {
                const option = document.createElement('option');
                option.value = cls;
                option.textContent = cls;
                classSelect.appendChild(option);
            });

            // Подкласс (фильтруется по классу)
            subclassSelect.innerHTML = '<option>Выберите Подкласс</option>';
            if (selectedFilters.class) {
                const subclasses = [...new Set(filteredData.filter(item => item.class === selectedFilters.class).map(item => item.subclass))].sort();
                subclasses.forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub;
                    option.textContent = sub;
                    subclassSelect.appendChild(option);
                });
            }

            // Тип (фильтруется по подклассу)
            typeSelect.innerHTML = '<option>Выберите Тип</option>';
            if (selectedFilters.subclass) {
                const types = [...new Set(filteredData.filter(item => item.subclass === selectedFilters.subclass).map(item => item.type))].sort();
                types.forEach(typ => {
                    const option = document.createElement('option');
                    option.value = typ;
                    option.textContent = typ;
                    typeSelect.appendChild(option);
                });
            }

            // Подтип (фильтруется по типу)
            subtypeSelect.innerHTML = '<option>Выберите Подтип</option>';
            if (selectedFilters.type) {
                const subtypes = [...new Set(filteredData.filter(item => item.type === selectedFilters.type).map(item => item.subtype))].sort();
                subtypes.forEach(subt => {
                    const option = document.createElement('option');
                    option.value = subt;
                    option.textContent = subt;
                    subtypeSelect.appendChild(option);
                });
            }

            // Группа (фильтруется по подтипу)
            groupSelect.innerHTML = '<option>Выберите Группу</option>';
            if (selectedFilters.subtype) {
                const groups = [...new Set(filteredData.filter(item => item.subtype === selectedFilters.subtype).map(item => item.group))].sort();
                groups.forEach(grp => {
                    const option = document.createElement('option');
                    option.value = grp;
                    option.textContent = grp;
                    groupSelect.appendChild(option);
                });
            }

            // Подгруппа (фильтруется по группе)
            subgroupSelect.innerHTML = '<option>Выберите Круг</option>';
            if (selectedFilters.group) {
                const subgroups = [...new Set(filteredData.filter(item => item.group === selectedFilters.group).map(item => item.subgroup))].sort();
                subgroups.forEach(subg => {
                    const option = document.createElement('option');
                    option.value = subg;
                    option.textContent = subg;
                    subgroupSelect.appendChild(option);
                });
            }
        }

        // Обработчики изменения фильтров
        document.getElementById('classSelect').addEventListener('change', function() {
            selectedFilters.class = this.value;
            selectedFilters.subclass = '';
            selectedFilters.type = '';
            selectedFilters.subtype = '';
            selectedFilters.group = '';
            selectedFilters.subgroup = '';
            filterData();
            populateFilters();
            drawCircles();
        });

        document.getElementById('subclassSelect').addEventListener('change', function() {
            selectedFilters.subclass = this.value;
            selectedFilters.type = '';
            selectedFilters.subtype = '';
            selectedFilters.group = '';
            selectedFilters.subgroup = '';
            filterData();
            populateFilters();
            drawCircles();
        });

        document.getElementById('typeSelect').addEventListener('change', function() {
            selectedFilters.type = this.value;
            selectedFilters.subtype = '';
            selectedFilters.group = '';
            selectedFilters.subgroup = '';
            filterData();
            populateFilters();
            drawCircles();
        });

        document.getElementById('subtypeSelect').addEventListener('change', function() {
            selectedFilters.subtype = this.value;
            selectedFilters.group = '';
            selectedFilters.subgroup = '';
            filterData();
            populateFilters();
            drawCircles();
        });

        document.getElementById('groupSelect').addEventListener('change', function() {
            selectedFilters.group = this.value;
            selectedFilters.subgroup = '';
            filterData();
            populateFilters();
            drawCircles();
        });

        document.getElementById('subgroupSelect').addEventListener('change', function() {
            selectedFilters.subgroup = this.value;
            filterData();
            drawCircles();
        });

        // Фильтрация данных
        function filterData() {
            filteredData = data.filter(item => {
                return (!selectedFilters.class || item.class === selectedFilters.class) &&
                       (!selectedFilters.subclass || item.subclass === selectedFilters.subclass) &&
                       (!selectedFilters.type || item.type === selectedFilters.type) &&
                       (!selectedFilters.subtype || item.subtype === selectedFilters.subtype) &&
                       (!selectedFilters.group || item.group === selectedFilters.group) &&
                       (!selectedFilters.subgroup || item.subgroup === selectedFilters.subgroup);
            });
        }

        // Рисование кругов
        function drawCircles() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (background.complete) {
                ctx.drawImage(background, 0, 0, canvas.width, canvas.height);
            }
            const visibleSubgroups = [...new Set(filteredData.map(item => item.subgroup))];
            circles.forEach(circle => {
                if (visibleSubgroups.includes(circle.id)) {
                    ctx.beginPath();
                    ctx.arc(circle.x, circle.y, 20, 0, 2 * Math.PI);
                    ctx.fillStyle = (blinkingCircleId === circle.id && isBlinking) ? 'red' : 'blue';
                    ctx.fill();
                    ctx.stroke();
                    ctx.fillStyle = 'white';
                    ctx.fillText(circle.id, circle.x - 10, circle.y + 5);
                }
            });
        }

        // Мигание круга
        document.getElementById('findPlantBtn').addEventListener('click', function() {
            const selectedSubgroup = selectedFilters.subgroup;
            if (!selectedSubgroup) {
                document.getElementById('status').textContent = 'Выберите круг в фильтре "Круг".';
                return;
            }
            blinkingCircleId = selectedSubgroup;
            isBlinking = true;
            if (blinkInterval) clearInterval(blinkInterval);
            blinkInterval = setInterval(() => {
                isBlinking = !isBlinking;
                drawCircles();
            }, 500);
            setTimeout(() => {
                clearInterval(blinkInterval);
                isBlinking = false;
                blinkingCircleId = null;
                drawCircles();
            }, 3000);
            document.getElementById('status').textContent = `Круг "${selectedSubgroup}" мигает 3 секунды.`;
        });

        // Переход в режим разработчика
        document.getElementById('switchToDeveloperBtn').addEventListener('click', function() {
            window.location.href = 'developer.html';  // Замените на реальную ссылку
        });

        // Инициализация
        background.onload = drawCircles;
        loadCircles().then(() => loadCSV()).then(() => drawCircles());
    </script>
</body>
</html>
