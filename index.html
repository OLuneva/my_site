<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Пользовательский режим - Управление кругами</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f0f0f0; }
        #container { display: flex; flex-direction: column; align-items: center; }
        #filters { margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
        select { padding: 5px; }
        #canvas { border: 1px solid #000; cursor: pointer; }
        .circle { position: absolute; border-radius: 50%; cursor: move; }
        .new-circle { background-color: red; }
        .old-circle { background-color: orange; }
    </style>
</head>
<body>
    <div id="container">
        <h1>Пользовательский режим</h1>
        <div id="filters">
            <select id="classSelect"><option>Выберите Класс</option></select>
            <select id="subclassSelect"><option>Выберите Подкласс</option></select>
            <select id="typeSelect"><option>Выберите Тип</option></select>
            <select id="subtypeSelect"><option>Выберите Подтип</option></select>
            <select id="groupSelect"><option>Выберите Группу</option></select>
            <select id="subgroupSelect"><option>Выберите Подгруппу</option></select>
        </div>
        <canvas id="canvas" width="800" height="600"></canvas>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const background = new Image();
        background.src = 'my-image.jpg'; // Замените на ваш фон

        let circles = JSON.parse(localStorage.getItem('circles')) || [];
        // Фильтрация невалидных элементов
        circles = circles.filter(circle => circle && circle.id && circle.id.trim() !== '');
        // Инициализация дефолтных кругов, если пусто
        if (circles.length === 0) {
            circles = [
                { id: 'circle_1', x: 100, y: 100, type: 'Тип1', isNew: false },
                { id: 'circle_2', x: 200, y: 200, type: 'Тип2', isNew: false },
                { id: 'circle_3', x: 300, y: 300, type: 'Тип3', isNew: false }
            ];
            localStorage.setItem('circles', JSON.stringify(circles));
        }

        let data = []; // Данные из CSV
        let filteredData = [];
        let selectedFilters = { class: '', subclass: '', type: '', subtype: '', group: '', subgroup: '' };
        let isDragging = false;
        let dragIndex = -1;

        // Загрузка CSV (асинхронно)
        async function loadCSV() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/oluneva/my_site/main/Plants.csv');
                const buffer = await response.arrayBuffer();
                const decoder = new TextDecoder('windows-1251');
                const csvText = decoder.decode(buffer);
                data = parseCSV(csvText);
                filteredData = data;
                updateFilters();
            } catch (e) {
                console.warn('CSV не загружен, используем демо-данные');
                data = [
                    { Класс: 'Класс1', Подкласс: 'Подкласс1', Тип: 'Тип1', Подтип: 'Подтип1', Группа: 'Группа1', Подгруппа: 'Подгруппа1' },
                    { Класс: 'Класс2', Подкласс: 'Подкласс2', Тип: 'Тип2', Подтип: 'Подтип2', Группа: 'Группа2', Подгруппа: 'Подгруппа2' }
                ];
                filteredData = data;
                updateFilters();
            }
        }

        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const headers = lines[0].split(',');
            return lines.slice(1).map(line => {
                const values = line.split(',');
                let obj = {};
                headers.forEach((h, i) => obj[h.trim()] = values[i]?.trim() || '');
                return obj;
            });
        }

        function updateFilters() {
            const selects = ['classSelect', 'subclassSelect', 'typeSelect', 'subtypeSelect', 'groupSelect', 'subgroupSelect'];
            const keys = ['Класс', 'Подкласс', 'Тип', 'Подтип', 'Группа', 'Подгруппа'];
            selects.forEach((id, i) => {
                const select = document.getElementById(id);
                select.innerHTML = `<option>Выберите ${keys[i]}</option>`;
                const unique = [...new Set(filteredData.map(d => d[keys[i]]))].filter(v => v);
                unique.forEach(val => {
                    const option = document.createElement('option');
                    option.value = val;
                    option.textContent = val;
                    select.appendChild(option);
                });
            });
        }

        function cascadeFilters(changedKey) {
            const keys = ['Класс', 'Подкласс', 'Тип', 'Подтип', 'Группа', 'Подгруппа'];
            const index = keys.indexOf(changedKey);
            filteredData = data.filter(d => {
                return keys.slice(0, index + 1).every(key => !selectedFilters[key.toLowerCase()] || d[key] === selectedFilters[key.toLowerCase()]);
            });
            updateFilters();
            renderCircles();
        }

        // Обработчики фильтров
        document.getElementById('classSelect').addEventListener('change', e => { selectedFilters.class = e.target.value; cascadeFilters('Класс'); });
        document.getElementById('subclassSelect').addEventListener('change', e => { selectedFilters.subclass = e.target.value; cascadeFilters('Подкласс'); });
        document.getElementById('typeSelect').addEventListener('change', e => { selectedFilters.type = e.target.value; cascadeFilters('Тип'); });
        document.getElementById('subtypeSelect').addEventListener('change', e => { selectedFilters.subtype = e.target.value; cascadeFilters('Подтип'); });
        document.getElementById('groupSelect').addEventListener('change', e => { selectedFilters.group = e.target.value; cascadeFilters('Группа'); });
        document.getElementById('subgroupSelect').addEventListener('change', e => { selectedFilters.subgroup = e.target.value; cascadeFilters('Подгруппа'); });

        function renderCircles() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(background, 0, 0, canvas.width, canvas.height);
            circles.forEach(circle => {
                if (!circle || !circle.id) return;
                const color = circle.isNew ? 'red' : 'orange';
                ctx.beginPath();
                ctx.arc(circle.x, circle.y, 20, 0, 2 * Math.PI);
                ctx.fillStyle = color;
                ctx.fill();
                ctx.stroke();
                ctx.fillStyle = 'white';
                ctx.font = '12px Arial';
                ctx.fillText(circle.id, circle.x - 15, circle.y + 5);
            });
        }

        // Drag-and-drop
        canvas.addEventListener('mousedown', e => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            dragIndex = circles.findIndex(circle => Math.sqrt((circle.x - x) ** 2 + (circle.y - y) ** 2) < 20);
            if (dragIndex !== -1) isDragging = true;
        });

        canvas.addEventListener('mousemove', e => {
            if (!isDragging || dragIndex === -1) return;
            const rect = canvas.getBoundingClientRect();
            circles[dragIndex].x = e.clientX - rect.left;
            circles[dragIndex].y = e.clientY - rect.top;
            renderCircles();
        });

        canvas.addEventListener('mouseup', () => {
            if (isDragging) {
                localStorage.setItem('circles', JSON.stringify(circles));
                isDragging = false;
                dragIndex = -1;
            }
        });

        background.onload = () => {
            loadCSV().then(() => renderCircles());
        };
    </script>
</body>
</html>

